<html>
<head>
  <title>Limb Tests</title>
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />

  <script src="../scriptaculous/lib/prototype.js" type="text/javascript"></script>
  <script src="../scriptaculous/src/unittest.js" type="text/javascript"></script>
  <link rel="stylesheet" href="../test.css" type="text/css" />

  <script src="../../Limb.js" type="text/javascript"></script>
  <script src="TestSourceFetcher.js" type="text/javascript"></script>
</head>
<body>
<h1>Limb package management</h1>
<p>
  Tests for bundle.
</p>

<div id="testlog"></div>
<div id="result"></div>

<script type="text/javascript" language="javascript" charset="utf-8">
// <![CDATA[
  new Test.Unit.Runner({
    tearDown: function()
    {
      TestSourceFetcher.cleanUp();
    },

    testCollectPackageWithoutDependencies: function()
    {
      TestSourceFetcher.set('Bar.js', 'var Bar = {};');

      var pkgName = 'Bar';
      var bundle = new Limb.Packages.Bundle(TestSourceFetcher, pkgName);
      var code = bundle.getSource();

      var expectedCode = "var Bar = {};\n";

      this.assertNotNull(code);
      this.assertEqual(expectedCode, code);
      this.assertEqual('Bar', bundle.getLoadedPackages()[0]);
    },

    testCollectPackageWithDependency: function()
    {
      TestSourceFetcher.set('Foo.js', "Limb.require(\"Bar\");\n var Foo = {};\n");
      TestSourceFetcher.set('Bar.js', 'var Bar = {};');

      var pkgName = 'Foo';
      var bundle = new Limb.Packages.Bundle(TestSourceFetcher, pkgName);
      var code = bundle.getSource();

      var expectedCode = "var Bar = {};\n var Foo = {};\n\n";

      this.assertNotNull(code);
      this.assertEqual(expectedCode, code);
      this.assertEqual('Foo', bundle.getLoadedPackages()[0]);
      this.assertEqual('Bar', bundle.getLoadedPackages()[1]);
    },

    testCollectPackageWithSeveralDependencies: function()
    {
      TestSourceFetcher.set('Zoo.js', "Limb.require('Foo');\nLimb.require(\"Bar\");\n" + 'var Zoo = {};');
      TestSourceFetcher.set('Bar.js', 'var Bar = {};');
      TestSourceFetcher.set('Foo.js', 'var Foo = {};');

      var pkgName = 'Zoo';
      var bundle = new Limb.Packages.Bundle(TestSourceFetcher, pkgName);
      var code = bundle.getSource();

      var expectedCode = "var Foo = {};\nvar Bar = {};\nvar Zoo = {};\n";

      this.assertNotNull(code);
      this.assertEqual(expectedCode, code);
      this.assertEqual('Zoo', bundle.getLoadedPackages()[0]);
      this.assertEqual('Foo', bundle.getLoadedPackages()[1]);
      this.assertEqual('Bar', bundle.getLoadedPackages()[2]);
    },

    testCollectPackageWithCyclicDependencies: function()
    {
      TestSourceFetcher.set('Foo.js', "Limb.require(\"Bar\");\n var Foo = {};");
      TestSourceFetcher.set('Bar.js', "Limb.require(\"Foo\");\n var Bar = {};");

      var pkgName = 'Foo';
      var bundle = new Limb.Packages.Bundle(TestSourceFetcher, pkgName);
      var code = bundle.getSource();

      var expectedCode = ' var Bar = {};\n var Foo = {};\n';

      this.assertNotNull(code);
      this.assertEqual(expectedCode, code);
      this.assertEqual('Foo', bundle.getLoadedPackages()[0]);
      this.assertEqual('Bar', bundle.getLoadedPackages()[1]);
    },

    testCollectPackageWithComplexDependencies: function()
    {
      TestSourceFetcher.set('Foo.js', "Limb.require(\"Bar\");\n var Foo = {};");
      TestSourceFetcher.set('Bar.js', "Limb.require(\"Zoo\");\n var Bar = {};");
      TestSourceFetcher.set('Zoo.js', "Limb.require('Foo');\nLimb.require('Bar');\n var Zoo = {};");

      var pkgName = 'Foo';
      var bundle = new Limb.Packages.Bundle(TestSourceFetcher, pkgName);
      var code = bundle.getSource();

      var expectedCode = ' var Zoo = {};\n var Bar = {};\n var Foo = {};\n';

      this.assertNotNull(code);
      this.assertEqual(expectedCode, code);
      this.assertEqual('Foo', bundle.getLoadedPackages()[0]);
      this.assertEqual('Bar', bundle.getLoadedPackages()[1]);
      this.assertEqual('Zoo', bundle.getLoadedPackages()[2]);
    },

    testCollectPackageWithDottedPath: function()
    {
      TestSourceFetcher.set('Foo/Bar.js', "Limb.require(\"Foo.Wow\");\n Foo.Bar = {};");
      TestSourceFetcher.set('Foo/Wow.js', "var Foo = {}; Foo.Wow = {};");

      var pkgName = 'Foo.Bar';
      var bundle = new Limb.Packages.Bundle(TestSourceFetcher, pkgName);
      var code = bundle.getSource();

      var expectedCode = 'var Foo = {}; Foo.Wow = {};\n Foo.Bar = {};\n';

      this.assertNotNull(code);
      this.assertEqual(expectedCode, code);
      this.assertEqual('Foo.Bar', bundle.getLoadedPackages()[0]);
      this.assertEqual('Foo.Wow', bundle.getLoadedPackages()[1]);
    }
  });
// ]]>
</script>
</body>
</html>