<html>
<head>
  <title>Limb Tests</title>
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />

  <script src="../scriptaculous/lib/prototype.js" type="text/javascript"></script>
  <script src="../scriptaculous/src/unittest.js" type="text/javascript"></script>
  <link rel="stylesheet" href="../test.css" type="text/css" />

  <script src="../../Limb.js" type="text/javascript"></script>
</head>
<body>
<h1>Limb package management</h1>
<p>
  Tests for Limb.Packages.SourceSplitter.
</p>

<div id="testlog"></div>
<div id="result"></div>

<script type="text/javascript" language="javascript" charset="utf-8">
// <![CDATA[
  new Test.Unit.Runner({

    testStripSingleComments: function()
    {
      var source = "//var Foo = {};\n var Bar = {};\n   //Hey";
      var chunks = Limb.Packages.SourceSplitter.splitSource(source);

      this.assertEqual(1, chunks.length);
      this.assertEqual(" var Bar = {};\n", chunks[0]['code']);
    },

    testSkipSingleCommentsNotInTheBeginning: function()
    {
      var source = "var Yo = 1;//var Foo = {};";
      var chunks = Limb.Packages.SourceSplitter.splitSource(source);

      this.assertEqual(1, chunks.length);
      this.assertEqual(source + '\n', chunks[0]['code']);
    },

    testStripBlockComments: function()
    {
      var source = "/*var Foo = {};*/ var Bar = {};";
      var chunks = Limb.Packages.SourceSplitter.splitSource(source);

      this.assertEqual(1, chunks.length);
      this.assertEqual(" var Bar = {};\n", chunks[0]['code']);
    },

    testStripMultilineBlockComments: function()
    {
      var source = "/*var Foo = {};\n*/ var Bar = {};";
      var chunks = Limb.Packages.SourceSplitter.splitSource(source);

      this.assertEqual(1, chunks.length);
      this.assertEqual(" var Bar = {};\n", chunks[0]['code']);
    },

    testSkipBlockCommentsNotInTheBeginning: function()
    {
      var source = "var Yo = 1;/*var Foo = {};*/ var Bar = {};";
      var chunks = Limb.Packages.SourceSplitter.splitSource(source);

      this.assertEqual(1, chunks.length);
      this.assertEqual(source + '\n', chunks[0]['code']);
    },

    testSkipMultilineBlockCommentsNotInTheBeginning: function()
    {
      var source = "var Yo = 1;/*var Foo = {};\n*/ var Bar = {};";
      var chunks = Limb.Packages.SourceSplitter.splitSource(source);

      this.assertEqual(2, chunks.length);
      this.assertEqual('var Yo = 1;/*var Foo = {};\n', chunks[0]['code']);
      this.assertEqual('*/ var Bar = {};\n', chunks[1]['code']);
    },

    testExtractOneWithDoubleQuotes: function()
    {
      var source = "Limb.require(\"Foo\");\n var Pkg = {};";
      var chunks = Limb.Packages.SourceSplitter.splitSource(source);

      this.assertEqual(2, chunks.length);
      this.assertEqual('Foo', chunks[0]['require']);
      this.assertEqual(" var Pkg = {};\n", chunks[1]['code']);
    },

    testExtractOneWithSingleQuotes: function()
    {
      var source = "Limb.require('Foo');\n var Pkg = {};";
      var chunks = Limb.Packages.SourceSplitter.splitSource(source);

      this.assertEqual(2, chunks.length);
      this.assertEqual('Foo', chunks[0]['require']);
      this.assertEqual(" var Pkg = {};\n", chunks[1]['code']);
    },

    testExtractWithEval: function()
    {
      var source = "Limb.require('F' + 'oo');\n var Pkg = {};";
      var chunks = Limb.Packages.SourceSplitter.splitSource(source);

      this.assertEqual(2, chunks.length);
      this.assertEqual('Foo', chunks[0]['require']);
      this.assertEqual(" var Pkg = {};\n", chunks[1]['code']);
    },

    testExtractSeveral: function()
    {
      var source = "Limb.require('Foo');\n var Pkg = {};\n" + 'Limb.require("Bar");';
      var chunks = Limb.Packages.SourceSplitter.splitSource(source);

      this.assertEqual(3, chunks.length);
      this.assertEqual('Foo', chunks[0]['require']);
      this.assertEqual(" var Pkg = {};\n", chunks[1]['code']);
      this.assertEqual('Bar', chunks[2]['require']);
    },

    testExtractSeveralĞ¡ontractWithIdenticalQuiotes: function()
    {
      var source = "Limb.require('Foo');\nLimb.require('Bar');\n var Pkg = {};";
      var chunks = Limb.Packages.SourceSplitter.splitSource(source);

      this.assertEqual(3, chunks.length);
      this.assertEqual('Foo', chunks[0]['require']);
      this.assertEqual('Bar', chunks[1]['require']);
      this.assertEqual(" var Pkg = {};\n", chunks[2]['code']);
    },

    testCollectCodeChunks: function()
    {
      var chunks = [[], [], []];
      chunks[0]['code'] = "var Foo = {};\n";
      chunks[1]['require'] = 'Bar';
      chunks[2]['code'] = "function foo() {};";

      var code = Limb.Packages.SourceSplitter.codeChunksOnly(chunks);
      this.assertNotNull(code);

      code = code.join('');
      this.assertEqual(chunks[0]['code'] + chunks[2]['code'], code);
    },

    testCollectRequireChunks: function()
    {
      var chunks = [[], [], [], []];
      chunks[0]['code'] = "var Foo = {};\n";
      chunks[1]['require'] = 'Bar';
      chunks[2]['code'] = "function foo() {};";
      chunks[3]['require'] = 'Foo';

      res = Limb.Packages.SourceSplitter.requireChunksOnly(chunks);
      this.assertEqual(res[0], 'Bar');
      this.assertEqual(res[1], 'Foo');
    },

    testExtractOnlyInTheGlobalScope: function()
    {
      var source = "{\n{Limb.require('Foo');}\n}";
      var chunks = Limb.Packages.SourceSplitter.splitSource(source);

      this.assertEqual(3, chunks.length);
      this.assertEqual('{\n', chunks[0]['code']);
      this.assertEqual("{Limb.require('Foo');}\n", chunks[1]['code']);
      this.assertEqual('}\n', chunks[2]['code']);
    },

    testWithMixedSyntax: function()
    {
      var source = "Limb.require('Foo');\n var Pkg = {};\nLimb.require('Bar');";
      var chunks = Limb.Packages.SourceSplitter.splitSource(source);

      this.assertEqual(3, chunks.length);
      this.assertEqual('Foo', chunks[0]['require']);
      this.assertEqual(" var Pkg = {};\n", chunks[1]['code']);
      this.assertEqual('Bar', chunks[2]['require']);
    }
  });
// ]]>
</script>
</body>
</html>